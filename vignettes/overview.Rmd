---
title: "diyar at a glance"
date: "`r format(Sys.Date(), '%d %B %Y')`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{diyar at a glance}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Overview
`diyar` is an `R` package for linking records with shared characteristics.
Linked records represent an entity, which depending on the context can represent unique patients, infection episodes, overlapping periods of care, clusters or other occurrences as defined by a case definition. Each entity is assigned an uniquely identifiable number. These identifiers are stored as an `S4` class with useful information about each group in their slots.

The package can assess and compare characteristics in a multitude of ways. This makes it useful in ordinarily complex analyses such as record linkage and contact or network analyses, or the application of case definitions. 

The main functions are `links()`, `episodes()` and `partitions()`.
They are flexible in terms of what and how they compare records, as well as what are considered matches. Their functionality can sometimes overlap however, each is better suited particular use cases: 

  + `links()` - link records with no relevance to an index. For example, deterministic record linkage
  + `episodes()` - link records in relation to an index record. For example, contact and network analysis.  
  + `partitions()` - link records in relation to a fixed boundary of time.

## links()
Link records with matching characteristics. Its key features are;

  + multi-stage record linkage. Here, multiple linkage criteria are assesed in a specified order of priority.

```{r warning = FALSE}
library(diyar)
data(missing_staff_id)
dfr_stages <- missing_staff_id[c("age", "hair_colour", "branch_office")]
priority_order_1 <- c("hair_colour", "branch_office")
priority_order_2 <- c("branch_office", "hair_colour")

dfr_stages$id.1 <- links(criteria = as.list(dfr_stages[priority_order_1]))
dfr_stages$id.2 <- links(criteria = as.list(dfr_stages[priority_order_2]))
```
  + create and use complex rules for record matching. This is done with a `sub_criteria()`.
```{r warning = FALSE}
sb1 <- sub_criteria(
  hair.color = dfr_stages$hair_colour,
  age = dfr_stages$age,
  match_funcs = c(
    "exact" = exact_match,
    "age.range" = range_match)
)
last_word_wf <- function(x) tolower(gsub("^.* ", "", x))
last_word_cmp <- function(x, y) last_word_wf(x) == last_word_wf(y)
not_equal <- function(x, y) x != y
sb2 <- sub_criteria(
  dfr_stages$branch_office, 
  dfr_stages$age,
  match_funcs = c(
    "last.word" = last_word_cmp,
    "not.equal" = not_equal)
)
sb3 <- sub_criteria(sb1, sb2, operator = "and")
sb1
sb2
sb3
dfr_stages$id.3 <- links(
  criteria = "place_holder",
  sub_criteria = list("cr1" = sb3)
)
dfr_stages
```
Similar functions like `links_wf_probabilistic()` and `links_sv_probabilistic()` exist for specific use cases including probablistic record linkage.

## episodes()
Links records in relation to an index record. Its key features are;

  + link records within a specified period from an index record.
```{r warning = FALSE}
dfr_2 <- data.frame(date = as.Date("2020-01-01") + c(1:5, 10:15, 20:25))
dfr_2$id.1 <- episodes(
  date = dfr_2$date, case_length = 2,
  episodes_max = 1)
```
  + change the index record.
```{r warning = FALSE}
dfr_2$pref <- c(rep(2, 8), 1, rep(2, 8))
dfr_2$id.2 <- episodes(
  date = dfr_2$date, case_length = number_line(-2, 2),
  episodes_max = 1, 
  custom_sort = dfr_2$pref)
```
  + add a recurrence period 
```{r warning = FALSE}
dfr_2$id.3 <- episodes(
  date = dfr_2$date, case_length = number_line(-2, 2), 
  episode_type = "rolling", recurrence_length = 1,
  episodes_max = 1, rolls_max = 1)
```  
+ link overlaping periods
```{r warning = FALSE}
dfr_2$period <- number_line(dfr_2$date, dfr_2$date + 5)
dfr_2$id.4 <- episodes(
  date = dfr_2$period, case_length = index_window(dfr_2$period),
  episodes_max = 1, rolls_max = 2)
dfr_2
```

There are other similar functions like `episodes_wf_splits()` for more specific use cases.

## partitions()
Links records in relation to a boundary in time. Its key features are;

  + link all records within a specific periods in time 
```{r warining = FALSE}
dfr_3 <- dfr_2["date"]
dfr_3$id.1 <- partitions(
  date = dfr_3$date, 
  window = number_line(as.Date(c("2020-01-10", "2020-01-17")), 
                       as.Date(c("2020-01-12", "2020-01-24")))
  )
```
  + link all records within a splits of an interval 
```{r warining = FALSE}
dfr_3$id.2 <- partitions(date = dfr_3$date, by = 3, separate = TRUE) 
dfr_3$id.3 <- partitions(date = dfr_3$date, length.out = 3, separate = TRUE)
dfr_3
```

Other useful functions include in the `diyar` package include `combi()` and `sets()`.
